# ITç‰©èµ„å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ç³»ç»Ÿï½œé€šçŸ¥æ¨¡æ¿å®šä¹‰ï¼ˆè‰æ¡ˆï¼‰

## 1. é€šçŸ¥æ¸ é“

### 1.1 æ”¯æŒæ¸ é“

| æ¸ é“ | Key | ä¼˜å…ˆçº§ | é€‚ç”¨åœºæ™¯ |
|-----|-----|-------|---------|
| é‚®ä»¶ | EMAIL | é«˜ | æè´§åˆ¸ã€å®¡æ‰¹ç»“æœã€å‘è´§é€šçŸ¥ |
| é’‰é’‰ | DINGTALK | ä¸­ | å¾…åŠæé†’ã€çŠ¶æ€å˜æ›´ |
| ç«™å†…ä¿¡ | IN_APP | ä½ | è¡¥å……é€šçŸ¥ |

### 1.2 é€šçŸ¥è§¦å‘æ—¶æœº

| äº‹ä»¶ | è§¦å‘æ¡ä»¶ | æ¥æ”¶äºº | æ¸ é“ |
|-----|---------|-------|------|
| ç”³è¯·æäº¤æˆåŠŸ | ç”³è¯·å•åˆ›å»º | ç”³è¯·äºº | EMAIL + IN_APP |
| å®¡æ‰¹å¾…åŠ | è¿›å…¥å®¡æ‰¹èŠ‚ç‚¹ | å®¡æ‰¹äºº | EMAIL + DINGTALK |
| å®¡æ‰¹é€šè¿‡ | é¢†å¯¼/ç®¡ç†å‘˜é€šè¿‡ | ç”³è¯·äºº | EMAIL + IN_APP |
| å®¡æ‰¹é©³å› | é¢†å¯¼/ç®¡ç†å‘˜é©³å› | ç”³è¯·äºº | EMAIL + IN_APP |
| å¾…è‡ªå–é€šçŸ¥ | è¿›å…¥ READY_OUTBOUNDï¼ˆè‡ªå–ï¼‰ | ç”³è¯·äºº | EMAILï¼ˆå«æè´§åˆ¸ï¼‰ |
| å·²å‘è´§é€šçŸ¥ | è¿›å…¥ SHIPPED | ç”³è¯·äºº | EMAIL + IN_APP |
| è¶…æ—¶å–æ¶ˆ | å®šæ—¶ä»»åŠ¡è‡ªåŠ¨å–æ¶ˆ | ç”³è¯·äºº | EMAIL + IN_APP |

## 2. é‚®ä»¶æ¨¡æ¿

### 2.1 æ¨¡æ¿ï¼šPICKUP_TICKETï¼ˆæè´§åˆ¸ï¼‰

**æ¨¡æ¿ Key**ï¼š`PICKUP_TICKET`

**è§¦å‘æ—¶æœº**ï¼šç”³è¯·å•è¿›å…¥ `READY_OUTBOUND` ä¸” `delivery_type=PICKUP`

**æ”¶ä»¶äºº**ï¼šç”³è¯·äººé‚®ç®±

**ä¸»é¢˜**ï¼š`[ITç‰©èµ„] æ‚¨çš„ç‰©èµ„ç”³è¯·å·²é€šè¿‡ï¼Œè¯·å‡­ç¥¨è‡ªå–`

**HTML æ¨¡æ¿**ï¼š

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
    .ticket { 
      max-width: 600px; 
      margin: 0 auto; 
      background: white; 
      border-radius: 8px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .header { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      color: white; 
      padding: 30px; 
      text-align: center; 
    }
    .content { padding: 30px; }
    .qr-code { text-align: center; margin: 30px 0; }
    .pickup-code { 
      font-size: 48px; 
      font-weight: bold; 
      letter-spacing: 8px; 
      color: #667eea; 
      text-align: center;
      margin: 20px 0;
    }
    .info-item { 
      padding: 15px; 
      border-bottom: 1px solid #eee; 
      display: flex; 
      justify-content: space-between;
    }
    .footer { 
      background: #f9f9f9; 
      padding: 20px; 
      text-align: center; 
      font-size: 12px; 
      color: #999;
    }
  </style>
</head>
<body>
  <div class="ticket">
    <div class="header">
      <h1>ğŸ« ITç‰©èµ„æè´§åˆ¸</h1>
      <p>è¯·å‡­æ­¤åˆ¸è‡³ IT ä»“åº“é¢†å–ç‰©èµ„</p>
    </div>
    
    <div class="content">
      <div class="qr-code">
        <img src="{{ qr_code_url }}" alt="æè´§äºŒç»´ç " width="200" height="200">
        <p style="color: #666;">æ‰«ç äº¤ä»˜ï¼ˆä¼˜å…ˆï¼‰</p>
      </div>
      
      <div class="pickup-code">{{ pickup_code_display }}</div>
      <p style="text-align: center; color: #999;">æ•°å­—æè´§ç ï¼ˆå¤‡ç”¨ï¼‰</p>
      
      <div style="margin-top: 30px;">
        <div class="info-item">
          <span>ç”³è¯·å•å·</span>
          <strong>#{{ application_id }}</strong>
        </div>
        <div class="info-item">
          <span>ç”³è¯·äºº</span>
          <strong>{{ applicant_name }}</strong>
        </div>
        <div class="info-item">
          <span>é¢†å–åœ°ç‚¹</span>
          <strong>{{ pickup_location }}</strong>
        </div>
        <div class="info-item">
          <span>ç‰©èµ„æ¸…å•</span>
          <div>
            {% for item in items %}
            <div>{{ item.sku_name }} Ã— {{ item.quantity }}</div>
            {% endfor %}
          </div>
        </div>
        <div class="info-item">
          <span>æœ‰æ•ˆæœŸè‡³</span>
          <strong style="color: #f56c6c;">{{ expires_at }}</strong>
        </div>
      </div>
    </div>
    
    <div class="footer">
      <p>âš ï¸ è¯·å¦¥å–„ä¿ç®¡æ­¤æè´§åˆ¸ï¼Œé—å¤±ä¸è¡¥</p>
      <p>å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³» IT èµ„äº§ç®¡ç†éƒ¨é—¨</p>
    </div>
  </div>
</body>
</html>
```

**å˜é‡æ¸…å•**ï¼š

```yaml
qr_code_url: äºŒç»´ç å›¾ç‰‡URLï¼ˆMinIOé¢„ç­¾åé“¾æ¥ï¼‰
pickup_code_display: æ ¼å¼åŒ–çš„æè´§ç ï¼ˆå¦‚ "892-110"ï¼‰
application_id: ç”³è¯·å•ID
applicant_name: ç”³è¯·äººå§“å
pickup_location: é¢†å–åœ°ç‚¹ï¼ˆé»˜è®¤ï¼š"ITä»“åº“ / ç§‘å…´ç§‘å­¦å›­ Aæ ‹ 1F"ï¼‰
items: ç‰©èµ„æ¸…å•æ•°ç»„
  - sku_name: SKU åç§°
  - quantity: æ•°é‡
expires_at: è¿‡æœŸæ—¶é—´ï¼ˆæ ¼å¼ï¼š"2026-02-12 23:59:59"ï¼‰
```

---

### 2.2 æ¨¡æ¿:APPROVAL_PENDING_LEADERï¼ˆé¢†å¯¼å¾…å®¡é€šçŸ¥ï¼‰

**æ¨¡æ¿ Key**ï¼š`APPROVAL_PENDING_LEADER`

**è§¦å‘æ—¶æœº**ï¼šç”³è¯·å•è¿›å…¥ `LOCKED`

**æ”¶ä»¶äºº**ï¼šç”³è¯·äººéƒ¨é—¨é¢†å¯¼

**ä¸»é¢˜**ï¼š`[å¾…åŠ] æ–°ç‰©èµ„ç”³è¯·éœ€è¦æ‚¨å®¡æ‰¹`

**é‚®ä»¶å†…å®¹**ï¼š

```html
<div style="padding: 20px; background: #f9f9f9;">
  <h2>æ–°ç‰©èµ„ç”³è¯·å¾…å®¡æ‰¹</h2>
  <p>æ‚¨å¥½ï¼Œ{{ leader_name }}ï¼š</p>
  <p>æœ‰ä¸€æ¡æ–°çš„ç‰©èµ„ç”³è¯·éœ€è¦æ‚¨å®¡æ‰¹ï¼š</p>
  
  <div style="background: white; padding: 20px; border-radius: 4px; margin: 20px 0;">
    <p><strong>ç”³è¯·äººï¼š</strong>{{ applicant_name }} ({{ applicant_department }})</p>
    <p><strong>ç”³è¯·ç‰©èµ„ï¼š</strong></p>
    <ul>
      {% for item in items %}
      <li>{{ item.sku_name }} Ã— {{ item.quantity }}</li>
      {% endfor %}
    </ul>
    <p><strong>ç”³è¯·ç†ç”±ï¼š</strong>{{ applicant_reason }}</p>
    
    {% if ai_suggestion %}
    <div style="background: #e6f7ff; padding: 15px; border-left: 4px solid #1890ff; margin-top: 15px;">
      <strong>ğŸ¤– AI å»ºè®®ï¼š</strong>{{ ai_suggestion.recommendation }}<br>
      <span style="color: #666;">{{ ai_suggestion.reason }}</span>
    </div>
    {% endif %}
  </div>
  
  <a href="{{ approval_link }}" style="
    display: inline-block;
    padding: 12px 24px;
    background: #667eea;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    margin-top: 10px;
  ">ç«‹å³å®¡æ‰¹</a>
</div>
```

---

### 2.3 æ¨¡æ¿ï¼šAPPROVAL_RESULTï¼ˆå®¡æ‰¹ç»“æœé€šçŸ¥ï¼‰

**æ¨¡æ¿ Key**ï¼š`APPROVAL_APPROVED` / `APPROVAL_REJECTED`

**è§¦å‘æ—¶æœº**ï¼šå®¡æ‰¹å®Œæˆ

**æ”¶ä»¶äºº**ï¼šç”³è¯·äºº

**ä¸»é¢˜**ï¼š`[é€šçŸ¥] æ‚¨çš„ç‰©èµ„ç”³è¯·å·²{{ result_text }}`

**é‚®ä»¶å†…å®¹**ï¼š

```html
<div style="padding: 20px;">
  <h2 style="color: {{ result_color }};">
    {{ result_icon }} æ‚¨çš„ç‰©èµ„ç”³è¯·å·²{{ result_text }}
  </h2>
  
  <p>ç”³è¯·å•å·ï¼š#{{ application_id }}</p>
  <p>å®¡æ‰¹äººï¼š{{ approver_name }}</p>
  <p>å®¡æ‰¹æ—¶é—´ï¼š{{ approved_at }}</p>
  
  {% if comment %}
  <div style="background: #f5f5f5; padding: 15px; border-radius: 4px; margin-top: 15px;">
    <strong>å®¡æ‰¹æ„è§ï¼š</strong>{{ comment }}
  </div>
  {% endif %}
  
  {% if is_approved %}
  <p style="color: #52c41a; margin-top: 20px;">
    âœ… æ‚¨çš„ç”³è¯·å·²é€šè¿‡ï¼Œç‰©èµ„æ­£åœ¨å‡†å¤‡ä¸­...
  </p>
  {% else %}
  <p style="color: #f5222d; margin-top: 20px;">
    âŒ ç”³è¯·æœªé€šè¿‡ï¼Œå¦‚æœ‰ç–‘é—®è¯·è”ç³»å®¡æ‰¹äºº
  </p>
  {% endif %}
</div>
```

**å˜é‡æ¸…å•**ï¼š

```yaml
result_text: "é€šè¿‡" / "é©³å›"
result_color: "#52c41a" / "#f5222d"
result_icon: "âœ…" / "âŒ"
is_approved: true / false
application_id: ç”³è¯·å•ID
approver_name: å®¡æ‰¹äººå§“å
approved_at: å®¡æ‰¹æ—¶é—´
comment: å®¡æ‰¹æ„è§ï¼ˆå¯é€‰ï¼‰
```

---

### 2.4 æ¨¡æ¿ï¼šSHIPPED_NOTIFYï¼ˆå‘è´§é€šçŸ¥ï¼‰

**æ¨¡æ¿ Key**ï¼š`SHIPPED_NOTIFY`

**è§¦å‘æ—¶æœº**ï¼šç”³è¯·å•è¿›å…¥ `SHIPPED`

**æ”¶ä»¶äºº**ï¼šç”³è¯·äºº

**ä¸»é¢˜**ï¼š`[å‘è´§] æ‚¨çš„ç‰©èµ„å·²å‘è´§`

**é‚®ä»¶å†…å®¹**ï¼š

```html
<div style="padding: 20px;">
  <h2>ğŸ“¦ æ‚¨çš„ç‰©èµ„å·²å‘è´§</h2>
  
  <p>ç”³è¯·å•å·ï¼š#{{ application_id }}</p>
  
  <div style="background: #fff7e6; padding: 15px; border-left: 4px solid #faad14; margin: 20px 0;">
    <p><strong>ç‰©æµå…¬å¸ï¼š</strong>{{ carrier }}</p>
    <p><strong>å¿«é€’å•å·ï¼š</strong>{{ tracking_no }}</p>
    <p><strong>å‘è´§æ—¶é—´ï¼š</strong>{{ shipped_at }}</p>
  </div>
  
  <p><strong>æ”¶ä»¶äººï¼š</strong>{{ receiver_name }} {{ receiver_phone }}</p>
  <p><strong>æ”¶ä»¶åœ°å€ï¼š</strong>{{ full_address }}</p>
  
  <p style="color: #999; margin-top: 20px;">
    é¢„è®¡ 2-3 ä¸ªå·¥ä½œæ—¥é€è¾¾ï¼Œè¯·ä¿æŒç”µè¯ç•…é€š
  </p>
</div>
```

---

### 2.5 æ¨¡æ¿ï¼šTIMEOUT_CANCELLEDï¼ˆè¶…æ—¶å–æ¶ˆé€šçŸ¥ï¼‰

**æ¨¡æ¿ Key**ï¼š`TIMEOUT_CANCELLED`

**è§¦å‘æ—¶æœº**ï¼šå®šæ—¶ä»»åŠ¡è‡ªåŠ¨å–æ¶ˆè¶…æ—¶ç”³è¯·

**æ”¶ä»¶äºº**ï¼šç”³è¯·äºº

**ä¸»é¢˜**ï¼š`[é€šçŸ¥] æ‚¨çš„ç‰©èµ„ç”³è¯·å·²è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ`

**é‚®ä»¶å†…å®¹**ï¼š

```html
<div style="padding: 20px;">
  <h2 style="color: #f5222d;">â° ç”³è¯·å·²è¶…æ—¶å–æ¶ˆ</h2>
  
  <p>ç”³è¯·å•å·ï¼š#{{ application_id }}</p>
  <p>æäº¤æ—¶é—´ï¼š{{ created_at }}</p>
  <p>å–æ¶ˆåŸå› ï¼šé•¿æ—¶é—´æœªå®Œæˆå®¡æ‰¹/é¢†å–ï¼Œç³»ç»Ÿè‡ªåŠ¨å–æ¶ˆ</p>
  
  <div style="background: #fff1f0; padding: 15px; border-left: 4px solid #ff4d4f; margin: 20px 0;">
    <p>å¦‚ä»éœ€æ­¤ç‰©èµ„ï¼Œè¯·é‡æ–°æäº¤ç”³è¯·</p>
  </div>
</div>
```

---

## 3. é’‰é’‰é€šçŸ¥æ¨¡æ¿

### 3.1 é’‰é’‰æœºå™¨äººæ¶ˆæ¯æ ¼å¼

```json
{
  "msgtype": "markdown",
  "markdown": {
    "title": "å¾…åŠæé†’",
    "text": "### æ–°ç‰©èµ„ç”³è¯·å¾…å®¡æ‰¹\n\n**ç”³è¯·äººï¼š**{{ applicant_name }}\n\n**ç”³è¯·ç‰©èµ„ï¼š**{{ items_summary }}\n\n**ç”³è¯·æ—¶é—´ï¼š**{{ created_at }}\n\n[ç«‹å³æŸ¥çœ‹]({{ approval_link }})"
  },
  "at": {
    "atMobiles": ["{{ leader_phone }}"],
    "isAtAll": false
  }
}
```

---

## 4. é€šçŸ¥å‘é€ç­–ç•¥

### 4.1 å‘é€é˜Ÿåˆ—

```python
# ä½¿ç”¨ Celery å¼‚æ­¥å‘é€
@celery.task(bind=True, max_retries=3)
def send_notification(self, notification_id: int):
    """å¼‚æ­¥å‘é€é€šçŸ¥"""
    try:
        notification = get_notification_by_id(notification_id)
        
        if notification.channel == "EMAIL":
            send_email(notification)
        elif notification.channel == "DINGTALK":
            send_dingtalk(notification)
        elif notification.channel == "IN_APP":
            send_in_app(notification)
            
        notification.status = "SENT"
        notification.save()
        
    except Exception as exc:
        notification.retry_count += 1
        notification.last_error = str(exc)
        notification.save()
        
        # æŒ‡æ•°é€€é¿é‡è¯•
        raise self.retry(exc=exc, countdown=60 * (2 ** notification.retry_count))
```

### 4.2 å¤±è´¥é‡è¯•

| é‡è¯•æ¬¡æ•° | é—´éš”æ—¶é—´ | ç´¯è®¡æ—¶é•¿ |
|---------|---------|---------|
| 1 | 1 åˆ†é’Ÿ | 1 åˆ†é’Ÿ |
| 2 | 2 åˆ†é’Ÿ | 3 åˆ†é’Ÿ |
| 3 | 4 åˆ†é’Ÿ | 7 åˆ†é’Ÿ |
| å¤±è´¥ | æ ‡è®°ä¸º FAILED | - |

### 4.3 é€šçŸ¥å»é‡

åŒä¸€äº‹ä»¶ + åŒä¸€ç”¨æˆ· + 5 åˆ†é’Ÿå†…ä¸é‡å¤å‘é€ç›¸åŒé€šçŸ¥ã€‚

```python
def should_send_notification(user_id: int, template_key: str, event_id: int) -> bool:
    """æ£€æŸ¥æ˜¯å¦éœ€è¦å‘é€é€šçŸ¥"""
    recent = Notification.filter(
        user_id=user_id,
        template_key=template_key,
        event_id=event_id,
        created_at__gte=datetime.utcnow() - timedelta(minutes=5)
    ).exists()
    
    return not recent
```

---

## 5. æ¨¡æ¿ç®¡ç†

### 5.1 æ¨¡æ¿å­˜å‚¨

**æ¨èæ–¹æ¡ˆ**ï¼šæ•°æ®åº“ + æ–‡ä»¶ç³»ç»Ÿæ··åˆ

- **è½»é‡æ¨¡æ¿**ï¼ˆé’‰é’‰/ç«™å†…ä¿¡ï¼‰ï¼šå­˜ `notification_template` è¡¨
- **å¤æ‚æ¨¡æ¿**ï¼ˆé‚®ä»¶ HTMLï¼‰ï¼šå­˜æ–‡ä»¶ç³»ç»Ÿ `/templates/email/*.html`

### 5.2 æ¨¡æ¿çƒ­æ›´æ–°

```python
# æ”¯æŒç®¡ç†å‘˜åœ¨åå°ç¼–è¾‘æ¨¡æ¿
class NotificationTemplate(Model):
    template_key = CharField(max_length=64, unique=True)
    channel = CharField(max_length=16)
    subject_template = CharField(max_length=255, null=True)
    content_template = TextField()
    is_active = BooleanField(default=True)
    version = IntegerField(default=1)
    updated_at = DateTimeField()
```

### 5.3 æµ‹è¯•å‘é€

ç®¡ç†å‘˜å¯åœ¨åå°è§¦å‘æµ‹è¯•é‚®ä»¶/é’‰é’‰æ¶ˆæ¯ã€‚

```yaml
POST /api/v1/admin/notifications/test
{
  "template_key": "PICKUP_TICKET",
  "receiver": "test@example.com",
  "variables": {
    "application_id": 123,
    "pickup_code_display": "999-888"
  }
}
```

---

## 6. æ•°æ®è¡¨å…³è”

è§ [30-MySQL-DDL.md](./30-MySQL-DDL.md) ä¸­çš„ `notification_outbox` è¡¨ã€‚
