# 模块 09｜资产生命周期管理（Asset Lifecycle）

## 1. 范围与目标

补充说明书中快捷入口"资产归还"与"故障报修"的完整流程，以及资产的报废、转移等全生命周期管理。

## 2. 前端路由与页面

- `/assets/return`：资产归还申请
- `/assets/repair`：故障报修
- `/assets/transfer`：资产转移（跨部门/跨用户）
- `/admin/assets/scrap`：资产报废管理

## 3. 资产归还流程

### 3.1 业务流程

```
用户发起归还 → 管理员验收 → Asset 状态: IN_USE → IN_STOCK
```

### 3.2 OpenAPI 草案

```yaml
paths:
  /api/v1/assets/return:
    post:
      summary: 创建归还申请
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [asset_ids, reason]
              properties:
                asset_ids:
                  type: array
                  items: { type: integer, format: int64 }
                  description: "要归还的资产ID列表"
                reason:
                  type: string
                  maxLength: 500
                  description: "归还原因"
      responses:
        "200":
          description: 归还申请已创建
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success: { type: boolean }
                  data:
                    type: object
                    required: [application_id, application_status, asset_status]
                    properties:
                      application_id: { type: integer, format: int64 }
                      application_status: { type: string, enum: [SUBMITTED] }
                      asset_status: { type: string, enum: [PENDING_INSPECTION] }

  /api/v1/admin/assets/return/{id}/confirm:
    post:
      summary: 管理员确认归还验收
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int64 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [passed]
              properties:
                passed:
                  type: boolean
                  description: "验收是否通过"
                damage_note:
                  type: string
                  nullable: true
                  description: "损坏说明（若未通过）"
      responses:
        "200":
          description: 验收完成
```

### 3.3 状态机扩展

| 事件 | 前置 | 目标 | 说明 |
|-----|------|------|------|
| return_asset | IN_USE | PENDING_INSPECTION | 用户发起归还，资产进入待验收 |
| confirm_return_pass | PENDING_INSPECTION | IN_STOCK | 管理员验收通过，资产归库 |
| confirm_return_fail | PENDING_INSPECTION | REPAIRING | 验收发现损坏，转入维修 |

## 4. 故障报修流程

### 4.1 业务流程

```
用户报修 → 管理员审批 → 送修 → 维修完成 → 归还用户
```

### 4.2 OpenAPI 草案

```yaml
paths:
  /api/v1/assets/repair:
    post:
      summary: 创建故障报修
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [asset_id, fault_description]
              properties:
                asset_id: { type: integer, format: int64 }
                fault_description:
                  type: string
                  maxLength: 1000
                  description: "故障描述"
                urgency:
                  type: string
                  enum: [LOW, MEDIUM, HIGH]
                  default: MEDIUM
      responses:
        "200":
          description: 报修单已创建
```

### 4.3 状态机扩展

| 事件 | 前置 | 目标 | 说明 |
|-----|------|------|------|
| start_repair | IN_USE | REPAIRING | 用户报修，资产进入维修状态 |
| finish_repair | REPAIRING | IN_USE | 维修完成，归还用户（holder 不变） |
| scrap_after_repair | REPAIRING | SCRAPPED | 维修评估后确认报废 |

## 5. 资产转移流程

### 5.1 业务流程

```
发起转移 → 原持有人确认 → 新持有人接收 → 更新 holder_user_id
```

### 5.2 OpenAPI 草案

```yaml
paths:
  /api/v1/assets/transfer:
    post:
      summary: 发起资产转移
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [asset_id, target_user_id, reason]
              properties:
                asset_id: { type: integer, format: int64 }
                target_user_id:
                  type: integer
                  format: int64
                  description: "目标持有人 ID"
                reason: { type: string, maxLength: 500 }
      responses:
        "200":
          description: 转移申请已创建
```

### 5.3 权限控制

- 只允许管理员或部门领导发起资产转移
- 转移需原持有人和新持有人双向确认（可选流程）

## 6. 资产报废流程

### 6.1 业务流程

```
管理员发起报废 → 领导审批 → 执行报废 → Asset 状态: SCRAPPED
```

### 6.2 OpenAPI 草案

```yaml
paths:
  /api/v1/admin/assets/scrap:
    post:
      summary: 发起资产报废
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [asset_ids, scrap_reason]
              properties:
                asset_ids:
                  type: array
                  items: { type: integer, format: int64 }
                scrap_reason:
                  type: string
                  enum: [DAMAGE, OBSOLETE, LOST]
                scrap_note:
                  type: string
                  nullable: true
      responses:
        "200":
          description: 报废申请已创建
```

### 6.3 限制规则

- 报废金额超过阈值（如单次 > 1 万元）需领导审批
- 报废后资产状态为 `SCRAPPED`，不可逆转
- 报废资产不参与库存聚合统计

## 7. 数据表补充

```sql
-- 归还/维修/转移申请表（复用 application 表的 type 枚举）
-- 已在 application 表中定义 type: ENUM('APPLY','RETURN','REPAIR')

-- 可选：维修记录扩展表
CREATE TABLE repair_record (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  asset_id BIGINT NOT NULL,
  application_id BIGINT NOT NULL,
  fault_description VARCHAR(1000) NOT NULL,
  repair_note VARCHAR(1000) NULL,
  repair_cost DECIMAL(10,2) NULL,
  repaired_by VARCHAR(128) NULL,
  started_at DATETIME(3) NOT NULL,
  completed_at DATETIME(3) NULL,
  created_at DATETIME(3) NOT NULL,
  updated_at DATETIME(3) NOT NULL,
  KEY idx_repair_asset (asset_id),
  KEY idx_repair_app (application_id),
  CONSTRAINT fk_repair_asset
    FOREIGN KEY (asset_id) REFERENCES asset(id)
    ON DELETE RESTRICT,
  CONSTRAINT fk_repair_app
    FOREIGN KEY (application_id) REFERENCES application(id)
    ON DELETE CASCADE
) ENGINE=InnoDB;

-- 资产转移记录
CREATE TABLE asset_transfer (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  asset_id BIGINT NOT NULL,
  from_user_id BIGINT NOT NULL,
  to_user_id BIGINT NOT NULL,
  reason VARCHAR(500) NOT NULL,
  status ENUM('PENDING','CONFIRMED','CANCELLED') NOT NULL,
  transferred_at DATETIME(3) NULL,
  created_at DATETIME(3) NOT NULL,
  updated_at DATETIME(3) NOT NULL,
  KEY idx_transfer_asset (asset_id),
  KEY idx_transfer_from (from_user_id),
  KEY idx_transfer_to (to_user_id),
  CONSTRAINT fk_transfer_asset
    FOREIGN KEY (asset_id) REFERENCES asset(id)
    ON DELETE RESTRICT,
  CONSTRAINT fk_transfer_from
    FOREIGN KEY (from_user_id) REFERENCES sys_user(id)
    ON DELETE RESTRICT,
  CONSTRAINT fk_transfer_to
    FOREIGN KEY (to_user_id) REFERENCES sys_user(id)
    ON DELETE RESTRICT
) ENGINE=InnoDB;
```

## 8. 前端组件清单

- **ReturnAssetForm**：归还申请表单
- **RepairRequestForm**：报修表单（含故障描述文本域）
- **TransferAssetForm**：转移表单（选择目标用户）
- **ScrapApprovalList**：报废审批列表
- **AssetLifecycleTimeline**：资产生命周期时间轴（展示入库→领用→报修→归还全过程）

## 9. 业务规则

### 9.1 归还限制

- 只能归还自己持有的资产（`holder_user_id = 当前用户`）
- 归还时必须填写原因
- 管理员验收发现损坏可直接转入维修状态

### 9.2 报修限制

- 只能报修自己持有的资产
- 报修后资产状态变为 `REPAIRING`，用户无法归还
- 维修完成后自动归还用户，holder 不变

### 9.3 转移限制

- 只允许管理员或部门领导发起
- 目标用户不能是当前持有人
- 转移完成后写 `StockFlow(TRANSFER)`

### 9.4 报废限制

- 只允许管理员操作
- 报废后资产不可恢复（除非数据库手动修复）
- 报废资产在"我的资产"中不再显示

## 10. 通知触发

| 事件 | 接收人 | 通知内容 |
|-----|-------|---------|
| 归还申请提交 | 管理员 | "用户 XXX 申请归还资产，请验收" |
| 归还验收通过 | 申请人 | "您的归还申请已通过" |
| 报修提交 | 管理员 | "用户 XXX 报修资产，请处理" |
| 维修完成 | 申请人 | "您的资产已维修完成" |
| 转移待确认 | 新持有人 | "有资产转移给您，请确认接收" |
| 报废审批 | 审批人 | "有资产报废申请需审批" |

## 11. 状态机关联

见 [10-状态机定义.md](../10-状态机定义.md) 的 Asset 状态机补充事件。
