# 模块 06｜入库与库存管理（Inbound & Inventory）

## 1. 范围与目标

- AI 智能入库：上传发票/送货单 → OCR 识别 → 自动填表 → 人工校对
- 赋码：入库完成生成资产标签（Asset Tag QR）并支持打印
- 库存操作：SKU/Asset 增删改查；库存数量由 Asset 聚合计算，不可手动改数字

## 2. 前端路由与页面

- `/inbound`：入库与库存管理

## 3. OpenAPI 草案（接口字段级别）

### 3.1 OCR 入库任务

```yaml
paths:
  /api/v1/inbound/ocr-jobs:
    post:
      summary: 创建 OCR 入库任务（上传图片）
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
                doc_type:
                  type: string
                  enum: [INVOICE, DELIVERY_NOTE]
                  nullable: true
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success: { type: boolean }
                  data:
                    type: object
                    required: [job_id, status]
                    properties:
                      job_id: { type: integer, format: int64 }
                      status: { type: string, enum: [PENDING, PROCESSING, READY_FOR_REVIEW, FAILED] }

  /api/v1/inbound/ocr-jobs/{id}:
    get:
      summary: 获取 OCR 任务详情与识别结果
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int64 }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success: { type: boolean }
                  data:
                    type: object
                    required: [job_id, status, source_file_url, extracted]
                    properties:
                      job_id: { type: integer, format: int64 }
                      status: { type: string }
                      source_file_url: { type: string }
                      extracted:
                        type: object
                        description: "OCR 结构化结果，允许存在误差，需人工校对"
                        additionalProperties: true

  /api/v1/inbound/ocr-jobs/{id}/confirm:
    post:
      summary: 人工校对并确认入库（批量创建 Asset）
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int64 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [sku, assets]
              properties:
                sku:
                  type: object
                  required: [category_id, brand, model, spec, reference_price]
                  properties:
                    category_id: { type: integer, format: int64 }
                    brand: { type: string }
                    model: { type: string }
                    spec: { type: string }
                    reference_price: { type: number, format: float }
                    cover_url: { type: string, nullable: true }
                    safety_stock_threshold: { type: integer, minimum: 0, default: 0 }
                assets:
                  type: array
                  minItems: 1
                  items:
                    type: object
                    required: [sn]
                    properties:
                      sn: { type: string }
                      inbound_at: { type: string, format: date-time, nullable: true }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success: { type: boolean }
                  data:
                    type: object
                    required: [sku_id, created_assets]
                    properties:
                      sku_id: { type: integer, format: int64 }
                      created_assets:
                        type: array
                        items:
                          type: object
                          required: [asset_id, asset_tag, sn]
                          properties:
                            asset_id: { type: integer, format: int64 }
                            asset_tag: { type: string }
                            sn: { type: string }
```

### 3.2 SKU/Asset 管理（管理员）

```yaml
paths:
  /api/v1/admin/skus:
    get:
      summary: SKU 列表（管理员）
      security: [{ bearerAuth: [] }]
      responses:
        "200": { description: OK }
    post:
      summary: 新增 SKU（管理员）
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [category_id, brand, model, spec, reference_price]
              properties:
                category_id: { type: integer, format: int64 }
                brand: { type: string }
                model: { type: string }
                spec: { type: string }
                reference_price: { type: number, format: float }
                cover_url: { type: string, nullable: true }
                safety_stock_threshold: { type: integer, minimum: 0, default: 0 }

  /api/v1/admin/assets:
    get:
      summary: Asset 列表（管理员）
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: sku_id
          schema: { type: integer, format: int64, nullable: true }
        - in: query
          name: status
          schema:
            type: string
            nullable: true
            enum: [IN_STOCK, LOCKED, IN_USE, BORROWED, REPAIRING, SCRAPPED]
      responses:
        "200": { description: OK }
    post:
      summary: 批量创建 Asset（管理员）
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [sku_id, assets]
              properties:
                sku_id: { type: integer, format: int64 }
                assets:
                  type: array
                  minItems: 1
                  items:
                    type: object
                    required: [sn]
                    properties:
                      sn: { type: string }
                      inbound_at: { type: string, format: date-time, nullable: true }
```

### 3.3 库存聚合查询（只读）

```yaml
paths:
  /api/v1/inventory/summary:
    get:
      summary: 库存汇总（按 SKU 聚合）
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: sku_id
          schema: { type: integer, format: int64, nullable: true }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success: { type: boolean }
                  data:
                    type: array
                    items:
                      type: object
                      required: [sku_id, total_count, in_stock_count, locked_count, in_use_count, repairing_count, scrapped_count]
                      properties:
                        sku_id: { type: integer, format: int64 }
                        total_count: { type: integer }
                        in_stock_count: { type: integer }
                        locked_count: { type: integer }
                        in_use_count: { type: integer }
                        repairing_count: { type: integer }
                        scrapped_count: { type: integer }
```

## 4. 数据表与状态机关联

- 数据表：sku、asset、stock_flow（入库/报废/维修）、category
- 状态机事件：inbound（Asset）、库存聚合仅查询

