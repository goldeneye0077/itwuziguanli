# 模块 07｜报表与分析（Analytics + Copilot）

## 1. 范围与目标

- 可视化报表：
  - 申领趋势图
  - 部门成本占比饼图
  - 资产状态分布图
- Copilot 查询：自然语言提问 → 返回结构化数据结果

## 2. 前端路由与页面

- `/analytics`：报表看板
- `/copilot`：自然语言查询

## 3. OpenAPI 草案（接口字段级别）

### 3.1 报表接口

```yaml
paths:
  /api/v1/reports/applications-trend:
    get:
      summary: 申领趋势（按天/周/月）
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: granularity
          schema: { type: string, enum: [DAY, WEEK, MONTH], default: DAY }
        - in: query
          name: start_date
          schema: { type: string, format: date }
        - in: query
          name: end_date
          schema: { type: string, format: date }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success: { type: boolean }
                  data:
                    type: array
                    items:
                      type: object
                      required: [bucket, count]
                      properties:
                        bucket: { type: string, example: "2026-02-01" }
                        count: { type: integer }

  /api/v1/reports/cost-by-department:
    get:
      summary: 部门成本占比
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: start_date
          schema: { type: string, format: date, nullable: true }
        - in: query
          name: end_date
          schema: { type: string, format: date, nullable: true }
      responses:
        "200":
          description: OK

  /api/v1/reports/asset-status-distribution:
    get:
      summary: 资产状态分布
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: OK
```

### 3.2 Copilot 查询（带安全护栏）

```yaml
paths:
  /api/v1/copilot/query:
    post:
      summary: 自然语言查询（返回结构化结果）
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [question]
              properties:
                question:
                  type: string
                  example: "上个季度谁领的设备最贵？"
                constraints:
                  type: object
                  nullable: true
                  description: "服务端可强制补充的查询约束（权限、部门、时间范围）"
                  additionalProperties: true
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success: { type: boolean }
                  data:
                    type: object
                    required: [query_plan, columns, rows]
                    properties:
                      query_plan:
                        type: object
                        description: "机器可读查询计划（禁止返回任意 SQL 直接执行）"
                        required: [metric, dimensions, filters, order_by, limit]
                        properties:
                          metric:
                            type: string
                            enum: [TOTAL_COST, MAX_COST, COUNT_APPLICATIONS, COUNT_ASSETS]
                          dimensions:
                            type: array
                            items:
                              type: string
                              enum: [USER, DEPARTMENT, SKU, CATEGORY, STATUS, MONTH]
                          filters:
                            type: array
                            items:
                              type: object
                              required: [field, op, value]
                              properties:
                                field: { type: string }
                                op: { type: string, enum: [EQ, IN, GTE, LTE, BETWEEN, CONTAINS] }
                                value: {}
                          order_by:
                            type: array
                            items:
                              type: object
                              required: [field, direction]
                              properties:
                                field: { type: string }
                                direction: { type: string, enum: [ASC, DESC] }
                          limit: { type: integer, minimum: 1, maximum: 200, default: 50 }
                      columns:
                        type: array
                        items: { type: string }
                      rows:
                        type: array
                        items:
                          type: array
                          items: {}
```

## 4. 数据表与状态机关联

- 数据表：application、application_item、application_asset、asset、sku、category、sys_user、stock_flow
- 状态机：只读分析；Copilot 仅查询，不改状态

