# 模块 04｜通知与验证（Notification & Verification）

## 1. 范围与目标

- 通知：邮件/钉钉推送（领取通知、审批结果、发货通知等）
- 双码验证：
  - QR Code：动态加密二维码（用于扫码枪/手机）
  - Pickup Code：6 位数字码（用于设备故障或人工核对）
- 提货券：邮件中的“票券化”呈现（强调二维码与数字码）

## 2. 前端路由与页面

- `/pickup-ticket/:applicationId`：提货券展示页

## 3. OpenAPI 草案（接口字段级别）

### 3.1 获取提货券信息

```yaml
paths:
  /api/v1/applications/{id}/pickup-ticket:
    get:
      summary: 获取提货券信息（二维码与数字码）
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int64 }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success: { type: boolean }
                  data:
                    type: object
                    required: [application_id, pickup_code, pickup_qr_string, expires_at, items]
                    properties:
                      application_id: { type: integer, format: int64 }
                      pickup_code: { type: string, example: "892110" }
                      pickup_code_display:
                        type: string
                        description: "前端展示用，如 892-110"
                        example: "892-110"
                      pickup_qr_string:
                        type: string
                        description: "用于生成二维码的字符串（建议包含过期与签名）"
                      expires_at:
                        type: string
                        format: date-time
                        nullable: true
                      items:
                        type: array
                        items:
                          type: object
                          required: [sku_id, quantity]
                          properties:
                            sku_id: { type: integer, format: int64 }
                            quantity: { type: integer }
```

### 3.2 双码校验（出库前置）

```yaml
paths:
  /api/v1/pickup/verify:
    post:
      summary: 校验扫码字符串或 6 位数字码
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [verify_type, value]
              properties:
                verify_type:
                  type: string
                  enum: [QR, CODE]
                value:
                  type: string
                  description: "verify_type=QR 时传 pickup_qr_string；verify_type=CODE 时传 pickup_code"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success: { type: boolean }
                  data:
                    type: object
                    required: [application_id, status, applicant_user_id, items, assigned_assets]
                    properties:
                      application_id: { type: integer, format: int64 }
                      status: { type: string }
                      applicant_user_id: { type: integer, format: int64 }
                      items:
                        type: array
                        items:
                          type: object
                          required: [sku_id, quantity]
                          properties:
                            sku_id: { type: integer, format: int64 }
                            quantity: { type: integer }
                      assigned_assets:
                        type: array
                        items:
                          type: object
                          required: [asset_id, asset_tag, sn]
                          properties:
                            asset_id: { type: integer, format: int64 }
                            asset_tag: { type: string }
                            sn: { type: string }
```

### 3.3 通知出站（运维自检/重试）

```yaml
paths:
  /api/v1/notifications/test:
    post:
      summary: 发送测试通知（仅管理员）
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [channel, receiver]
              properties:
                channel: { type: string, enum: [EMAIL, DINGTALK] }
                receiver: { type: string, example: "user@example.com" }
                message: { type: string, nullable: true }
      responses:
        "200":
          description: OK
```

## 4. 数据表与状态机关联

- 数据表：application（pickup_code、pickup_qr_string）、notification_outbox、application_item、application_asset、asset
- 状态机事件：mark_ready_outbound、confirm_pickup、ship_express（见 [10-状态机定义.md](file:///e:/itwzgl/docs/proposal/10-%E7%8A%B6%E6%80%81%E6%9C%BA%E5%AE%9A%E4%B9%89.md)）

