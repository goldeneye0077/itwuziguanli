# 模块 03｜智能审批流（Workflow）

## 1. 范围与目标

- 领导初审：展示申请理由 + AI 建议；通过/驳回
- 管理员复审：确认是否有实物可分配；系统根据 SKU 自动挑选空闲 Asset 并锁定；管理员最终确认分配
- 申请详情：流转历史、明细、分配资产清单

## 2. 前端路由与页面

- `/approvals/leader`：领导待办
- `/approvals/admin`：管理员待办
- `/applications/:id`：申请详情（复用用户侧详情页，但组件与操作按钮按权限显示）

## 3. OpenAPI 草案（接口字段级别）

### 3.1 审批待办

```yaml
paths:
  /api/v1/approvals/inbox:
    get:
      summary: 获取待办（按当前角色过滤）
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: node
          schema:
            type: string
            enum: [LEADER, ADMIN]
          required: true
        - in: query
          name: status
          schema:
            type: string
            nullable: true
            enum: [LOCKED, LEADER_APPROVED]
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: page_size
          schema: { type: integer, minimum: 1, maximum: 50, default: 20 }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [success, data, meta]
                properties:
                  success: { type: boolean }
                  data:
                    type: array
                    items:
                      type: object
                      required: [application_id, applicant, delivery_type, status, created_at, items_summary, ai_suggestion]
                      properties:
                        application_id: { type: integer, format: int64 }
                        applicant:
                          type: object
                          required: [id, name, department_id]
                          properties:
                            id: { type: integer, format: int64 }
                            name: { type: string }
                            department_id: { type: integer, format: int64 }
                        delivery_type: { type: string, enum: [PICKUP, EXPRESS] }
                        status: { type: string }
                        created_at: { type: string, format: date-time }
                        items_summary:
                          type: array
                          items:
                            type: object
                            required: [sku_id, quantity]
                            properties:
                              sku_id: { type: integer, format: int64 }
                              quantity: { type: integer }
                        ai_suggestion:
                          type: object
                          nullable: true
                          properties:
                            recommendation: { type: string, enum: [PASS, REJECT] }
                            reason: { type: string }
                  meta: { $ref: "#/components/schemas/PageMeta" }
```

### 3.2 申请详情（含流转与分配）

```yaml
paths:
  /api/v1/applications/{id}:
    get:
      summary: 获取申请详情（含明细、历史、物流、分配资产）
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int64 }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success: { type: boolean }
                  data:
                    type: object
                    required: [application, approval_history, assigned_assets]
                    properties:
                      application: { $ref: "#/components/schemas/Application" }
                      approval_history:
                        type: array
                        items: { $ref: "#/components/schemas/ApprovalHistoryItem" }
                      logistics:
                        $ref: "#/components/schemas/Logistics"
                        nullable: true
                      assigned_assets:
                        type: array
                        items:
                          type: object
                          required: [asset_id, asset_tag, sn, sku_id, status]
                          properties:
                            asset_id: { type: integer, format: int64 }
                            asset_tag: { type: string }
                            sn: { type: string }
                            sku_id: { type: integer, format: int64 }
                            status: { type: string }

components:
  schemas:
    ApprovalHistoryItem:
      type: object
      required: [id, node, action, actor_user_id, created_at]
      properties:
        id: { type: integer, format: int64 }
        node: { type: string, enum: [LEADER, ADMIN] }
        action: { type: string, enum: [APPROVE, REJECT] }
        actor_user_id: { type: integer, format: int64 }
        comment: { type: string, nullable: true }
        ai_recommendation_json: { type: object, nullable: true }
        created_at: { type: string, format: date-time }
```

### 3.3 审批动作（领导/管理员）

```yaml
paths:
  /api/v1/applications/{id}/approve:
    post:
      summary: 审批通过/驳回（领导或管理员）
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int64 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [node, action]
              properties:
                node: { type: string, enum: [LEADER, ADMIN] }
                action: { type: string, enum: [APPROVE, REJECT] }
                comment: { type: string, maxLength: 500, nullable: true }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success: { type: boolean }
                  data:
                    type: object
                    required: [application_id, status]
                    properties:
                      application_id: { type: integer, format: int64 }
                      status: { type: string }
```

### 3.4 分配资产（管理员复审）

```yaml
paths:
  /api/v1/applications/{id}/assign-assets:
    post:
      summary: 管理员确认/调整分配的具体 Asset 实例
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int64 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [assignments]
              properties:
                assignments:
                  type: array
                  minItems: 1
                  items:
                    type: object
                    required: [sku_id, asset_ids]
                    properties:
                      sku_id: { type: integer, format: int64 }
                      asset_ids:
                        type: array
                        minItems: 1
                        items: { type: integer, format: int64 }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success: { type: boolean }
                  data:
                    type: object
                    required: [application_id, assigned_assets]
                    properties:
                      application_id: { type: integer, format: int64 }
                      assigned_assets:
                        type: array
                        items:
                          type: object
                          required: [asset_id, asset_tag, sn, sku_id]
                          properties:
                            asset_id: { type: integer, format: int64 }
                            asset_tag: { type: string }
                            sn: { type: string }
                            sku_id: { type: integer, format: int64 }
```

## 4. 数据表与状态机关联

- 数据表：application、application_item、approval_history、application_asset、asset、stock_flow
- 状态机事件：leader_approve/leader_reject、admin_approve/admin_reject、mark_ready_outbound（见 [10-状态机定义.md](file:///e:/itwzgl/docs/proposal/10-%E7%8A%B6%E6%80%81%E6%9C%BA%E5%AE%9A%E4%B9%89.md)）

