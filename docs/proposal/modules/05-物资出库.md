# 模块 05｜物资出库（Smart Outbound）

## 1. 范围与目标

管理员作业台（两个 Tab）：

- 待自取（Pickup Queue）：扫码员工二维码或输入 6 位数字码 → 展示物资明细与 SN → 确认交付
- 待发货（Express Queue）：选择订单 → 录入快递单号与物流公司 → 状态变更并触发通知

## 2. 前端路由与页面

- `/outbound`：出库作业台（Tabs：PickupQueueTab / ExpressQueueTab）

## 3. OpenAPI 草案（接口字段级别）

### 3.1 待自取队列

```yaml
paths:
  /api/v1/outbound/pickup-queue:
    get:
      summary: 获取待自取订单列表
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: page_size
          schema: { type: integer, minimum: 1, maximum: 50, default: 20 }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [success, data, meta]
                properties:
                  success: { type: boolean }
                  data:
                    type: array
                    items:
                      type: object
                      required: [application_id, applicant_user_id, pickup_code, created_at, items]
                      properties:
                        application_id: { type: integer, format: int64 }
                        applicant_user_id: { type: integer, format: int64 }
                        pickup_code: { type: string }
                        created_at: { type: string, format: date-time }
                        items:
                          type: array
                          items:
                            type: object
                            required: [sku_id, quantity]
                            properties:
                              sku_id: { type: integer, format: int64 }
                              quantity: { type: integer }
                  meta: { $ref: "#/components/schemas/PageMeta" }
```

### 3.2 确认交付（自取）

```yaml
paths:
  /api/v1/outbound/confirm-pickup:
    post:
      summary: 自取确认交付（扣减库存，资产转在用）
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [verify_type, value]
              properties:
                verify_type: { type: string, enum: [QR, CODE, APPLICATION_ID] }
                value:
                  type: string
                  description: "verify_type=QR/CODE 时对应扫码或领取码；APPLICATION_ID 时传申请单ID字符串"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success: { type: boolean }
                  data:
                    type: object
                    required: [application_id, status, delivered_assets]
                    properties:
                      application_id: { type: integer, format: int64 }
                      status: { type: string, enum: [OUTBOUNDED, DONE] }
                      delivered_assets:
                        type: array
                        items:
                          type: object
                          required: [asset_id, asset_tag, sn]
                          properties:
                            asset_id: { type: integer, format: int64 }
                            asset_tag: { type: string }
                            sn: { type: string }
```

### 3.3 待发货队列与发货录入

```yaml
paths:
  /api/v1/outbound/express-queue:
    get:
      summary: 获取待发货订单列表
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: page_size
          schema: { type: integer, minimum: 1, maximum: 50, default: 20 }
      responses:
        "200":
          description: OK

  /api/v1/outbound/ship:
    post:
      summary: 发货录入（快递单号/物流公司）
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [application_id, carrier, tracking_no]
              properties:
                application_id: { type: integer, format: int64 }
                carrier: { type: string, example: "SF" }
                tracking_no: { type: string, example: "SF1234567890" }
                shipped_at:
                  type: string
                  format: date-time
                  nullable: true
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success: { type: boolean }
                  data:
                    type: object
                    required: [application_id, status]
                    properties:
                      application_id: { type: integer, format: int64 }
                      status: { type: string, enum: [SHIPPED] }
```

## 4. 数据表与状态机关联

- 数据表：application、logistics、application_asset、asset、stock_flow、notification_outbox
- 状态机事件：confirm_pickup、ship_express（见 [10-状态机定义.md](file:///e:/itwzgl/docs/proposal/10-%E7%8A%B6%E6%80%81%E6%9C%BA%E5%AE%9A%E4%B9%89.md)）

