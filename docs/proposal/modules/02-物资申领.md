# 模块 02｜物资申领（电商化体验）

## 1. 范围与目标

- 物资超市：分类树 + SKU 卡片（图片、可用库存）
- 购物车：加入清单、数量调整
- 结算抽屉：配送方式（自取/快递）与地址表单；支持“保存地址/使用上次地址”
- AI 预审：提交瞬间生成“职位 vs 申请物资”匹配建议

## 2. 前端路由与页面

- `/store`：物资超市
- `/applications`：我的申请（列表）
- `/applications/:id`：申请详情

## 3. OpenAPI 草案（接口字段级别）

### 3.1 分类与 SKU

```yaml
paths:
  /api/v1/categories/tree:
    get:
      summary: 获取分类树
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success: { type: boolean }
                  data:
                    type: array
                    items:
                      type: object
                      required: [id, name, children]
                      properties:
                        id: { type: integer, format: int64 }
                        name: { type: string }
                        children:
                          type: array
                          items: { $ref: "#/components/schemas/CategoryTreeNode" }

  /api/v1/skus:
    get:
      summary: 搜索/分页获取 SKU 列表（含可用库存聚合）
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: category_id
          schema: { type: integer, format: int64, nullable: true }
        - in: query
          name: keyword
          schema: { type: string, nullable: true }
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: page_size
          schema: { type: integer, minimum: 1, maximum: 50, default: 20 }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [success, data, meta]
                properties:
                  success: { type: boolean }
                  data:
                    type: array
                    items: { $ref: "#/components/schemas/Sku" }
                  meta: { $ref: "#/components/schemas/PageMeta" }

components:
  schemas:
    CategoryTreeNode:
      type: object
      required: [id, name, children]
      properties:
        id: { type: integer, format: int64 }
        name: { type: string }
        children:
          type: array
          items: { $ref: "#/components/schemas/CategoryTreeNode" }
```

### 3.2 地址簿（快递寄送）

```yaml
paths:
  /api/v1/me/addresses:
    get:
      summary: 获取当前用户地址簿
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success: { type: boolean }
                  data:
                    type: array
                    items: { $ref: "#/components/schemas/UserAddress" }

    post:
      summary: 新增地址
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [receiver_name, receiver_phone, province, city, district, detail]
              properties:
                receiver_name: { type: string }
                receiver_phone: { type: string }
                province: { type: string }
                city: { type: string }
                district: { type: string }
                detail: { type: string }
                is_default: { type: boolean, default: false }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success: { type: boolean }
                  data: { $ref: "#/components/schemas/UserAddress" }

components:
  schemas:
    UserAddress:
      type: object
      required: [id, user_id, receiver_name, receiver_phone, province, city, district, detail, is_default]
      properties:
        id: { type: integer, format: int64 }
        user_id: { type: integer, format: int64 }
        receiver_name: { type: string }
        receiver_phone: { type: string }
        province: { type: string }
        city: { type: string }
        district: { type: string }
        detail: { type: string }
        is_default: { type: boolean }
```

### 3.3 创建申请单（锁库 + 领取码）

```yaml
paths:
  /api/v1/applications:
    post:
      summary: 创建申请单（电商化结算）
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [type, delivery_type, items]
              properties:
                type:
                  type: string
                  enum: [APPLY, RETURN, REPAIR]
                  example: APPLY
                delivery_type:
                  type: string
                  enum: [PICKUP, EXPRESS]
                  example: PICKUP
                items:
                  type: array
                  minItems: 1
                  items:
                    type: object
                    required: [sku_id, quantity]
                    properties:
                      sku_id: { type: integer, format: int64 }
                      quantity: { type: integer, minimum: 1, maximum: 50 }
                      note: { type: string, maxLength: 500, nullable: true }
                express_address_id:
                  type: integer
                  format: int64
                  nullable: true
                  description: "delivery_type=EXPRESS 时可传已有地址ID"
                express_address:
                  $ref: "#/components/schemas/ExpressAddress"
                applicant_reason:
                  type: string
                  maxLength: 1000
                  nullable: true
                  description: "用于审批展示与 AI 预审输入"
                applicant_job_title:
                  type: string
                  maxLength: 128
                  nullable: true
                  description: "用于 AI 预审输入"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success: { type: boolean }
                  data: { $ref: "#/components/schemas/Application" }

components:
  schemas:
    ExpressAddress:
      type: object
      required: [receiver_name, receiver_phone, province, city, district, detail]
      properties:
        receiver_name: { type: string }
        receiver_phone: { type: string }
        province: { type: string }
        city: { type: string }
        district: { type: string }
        detail: { type: string }
```

### 3.4 AI 预审（可选独立接口）

```yaml
paths:
  /api/v1/ai/precheck:
    post:
      summary: AI 预审建议（职位 vs 申请物资匹配）
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [job_title, reason, items]
              properties:
                job_title: { type: string }
                reason: { type: string }
                items:
                  type: array
                  minItems: 1
                  items:
                    type: object
                    required: [sku_id, quantity]
                    properties:
                      sku_id: { type: integer, format: int64 }
                      quantity: { type: integer, minimum: 1 }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success: { type: boolean }
                  data:
                    type: object
                    required: [recommendation, reason]
                    properties:
                      recommendation:
                        type: string
                        enum: [PASS, REJECT]
                      reason:
                        type: string
```

## 4. 数据表与状态机关联

- 数据表：category、sku、asset、application、application_item、application_asset、user_address、approval_history（AI 建议可存 ai_recommendation_json）
- 状态机：create_application、lock_inventory（见 [10-状态机定义.md](../10-状态机定义.md)）
