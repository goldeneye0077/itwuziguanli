# IT物资全生命周期管理系统｜部署与运维（草案）

## 1. 技术栈版本要求

| 组件 | 版本 | 说明 |
|-----|------|------|
| Python | 3.12+ | 后端核心 |
| Node.js | 20+ LTS | 前端构建 |
| MySQL | 8.0+ | 业务数据库 |
| Redis | 7.0+ | 缓存/任务队列 |
| MinIO | Latest | 对象存储 |
| Docker | 24.0+ | 容器化 |
| Nginx | 1.24+ | 反向代理 |

## 2. Docker Compose 完整配置

### 2.1 docker-compose.yml

> 说明：以下配置以“生产安全默认”优先。若用于本地联调，可通过 override 文件临时开放端口与挂载源码目录。

```yaml
version: '3.8'

services:
  # MySQL 数据库
  mysql:
    image: mysql:8.0
    container_name: it_assets_mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:?set in .env}
      MYSQL_DATABASE: it_assets
      MYSQL_USER: it_assets_user
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:?set in .env}
      TZ: Asia/Shanghai
    ports:
      - "127.0.0.1:3306:3306"
    volumes:
      - ./data/mysql:/var/lib/mysql
      - ./deploy/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql
    command: --default-authentication-plugin=mysql_native_password
    networks:
      - it_assets_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Redis 缓存
  redis:
    image: redis:7.0-alpine
    container_name: it_assets_redis
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - ./data/redis:/data
    networks:
      - it_assets_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # MinIO 对象存储
  minio:
    image: minio/minio:latest
    container_name: it_assets_minio
    ports:
      - "127.0.0.1:9000:9000"
      - "127.0.0.1:9001:9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:?set in .env}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:?set in .env}
    volumes:
      - ./data/minio:/data
    command: server /data --console-address ":9001"
    networks:
      - it_assets_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # 后端 API 服务
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: it_assets_backend
    environment:
      DATABASE_URL: ${DATABASE_URL:?set in .env}
      REDIS_URL: ${REDIS_URL:?set in .env}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:?set in .env}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:?set in .env}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:?set in .env}
      JWT_SECRET: ${JWT_SECRET:?set in .env}
      ENVIRONMENT: production
    ports:
      - "8000:8000"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - it_assets_network
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000

  # Celery Worker
  celery_worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: it_assets_celery_worker
    environment:
      DATABASE_URL: ${DATABASE_URL:?set in .env}
      REDIS_URL: ${REDIS_URL:?set in .env}
    depends_on:
      - mysql
      - redis
    networks:
      - it_assets_network
    command: celery -A app.tasks worker --loglevel=info

  # Celery Beat（定时任务）
  celery_beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: it_assets_celery_beat
    environment:
      DATABASE_URL: ${DATABASE_URL:?set in .env}
      REDIS_URL: ${REDIS_URL:?set in .env}
    depends_on:
      - mysql
      - redis
    networks:
      - it_assets_network
    command: celery -A app.tasks beat --loglevel=info

  # 前端服务
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: it_assets_frontend
    ports:
      - "3000:80"
    depends_on:
      - backend
    networks:
      - it_assets_network

  # Nginx 反向代理
  nginx:
    image: nginx:1.24-alpine
    container_name: it_assets_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deploy/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./deploy/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - backend
      - frontend
    networks:
      - it_assets_network

networks:
  it_assets_network:
    driver: bridge
```

### 2.2 后端 Dockerfile

```dockerfile
# backend/Dockerfile
FROM python:3.12-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    default-libmysqlclient-dev \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

# 安装 Python 依赖
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制代码
COPY . .

EXPOSE 8000

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### 2.3 前端 Dockerfile

```dockerfile
# frontend/Dockerfile
FROM node:20-alpine AS builder

WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

# Nginx 镜像
FROM nginx:1.24-alpine

COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

## 3. Nginx 配置

### 3.1 nginx.conf

```nginx
upstream backend_api {
    server backend:8000;
}

upstream frontend_app {
    server frontend:80;
}

server {
    listen 80;
    server_name localhost;

    # 前端静态资源
    location / {
        proxy_pass http://frontend_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 后端 API
    location /api/ {
        proxy_pass http://backend_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket 支持（可选）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # MinIO 对象存储
    location /minio/ {
        proxy_pass http://minio:9000/;
        proxy_set_header Host $host;
        
        # 大文件上传支持
        client_max_body_size 50M;
    }

    # 健康检查
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}

# HTTPS 配置（生产环境）
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # ... 其他配置同上 ...
}
```

## 4. 环境变量配置

### 4.1 .env 模板

> 生产环境请使用高强度随机密钥，不要使用示例值。

```bash
# backend/.env

# 数据库
DATABASE_URL=mysql+aiomysql://user:pass@localhost:3306/it_assets

# Redis
REDIS_URL=redis://localhost:6379/0

# MinIO
MINIO_ENDPOINT=localhost:9000
MINIO_ROOT_USER=replace_with_strong_user
MINIO_ROOT_PASSWORD=replace_with_strong_password
MINIO_ACCESS_KEY=replace_with_service_access_key
MINIO_SECRET_KEY=replace_with_service_secret_key
MINIO_SECURE=false

# JWT
JWT_SECRET=replace_with_64_chars_random_secret
JWT_ALGORITHM=HS256
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=120
JWT_REFRESH_TOKEN_EXPIRE_DAYS=7

# 邮件配置
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=notifications@example.com
SMTP_PASSWORD=your-smtp-password
SMTP_FROM=IT资产管理系统 <notifications@example.com>

# 钉钉机器人
DINGTALK_WEBHOOK_URL=https://oapi.dingtalk.com/robot/send?access_token=xxx

# AI 接口
OPENAI_API_KEY=sk-xxx
OPENAI_API_BASE=https://api.deepseek.com/v1

# 环境
ENVIRONMENT=production
DEBUG=false
```

## 5. 部署流程

### 5.1 首次部署

```bash
# 1. 克隆代码
git clone https://github.com/your-org/it-assets.git
cd it-assets

# 2. 配置环境变量
cp backend/.env.example backend/.env
vi backend/.env  # 修改配置

# 3. 启动服务
docker-compose up -d

# 4. 等待服务健康检查通过
docker-compose ps

# 5. 初始化数据库（如需要）
docker-compose exec backend python -m alembic upgrade head

# 6. 创建初始管理员
docker-compose exec backend python scripts/create_admin.py

# 7. 访问系统
# 前端: http://localhost
# 后端API: http://localhost/api
# MinIO控制台: http://localhost:9001
```

### 5.2 更新部署

```bash
# 1. 拉取最新代码
git pull origin main

# 2. 停止服务
docker-compose down

# 3. 重新构建镜像
docker-compose build

# 4. 启动服务
docker-compose up -d

# 5. 数据库迁移（如有更新）
docker-compose exec backend python -m alembic upgrade head

# 6. 检查服务状态
docker-compose logs -f --tail=100
```

## 6. 监控与日志

### 6.1 日志收集

```yaml
# 在 docker-compose.yml 中添加日志配置
services:
  backend:
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

### 6.2 查看日志

```bash
# 查看所有服务日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f backend

# 查看最近 100 行
docker-compose logs --tail=100 backend
```

### 6.3 健康检查

```bash
# 检查所有服务健康状态
docker-compose ps

# 检查数据库连接
docker-compose exec mysql mysqladmin ping -h localhost

# 检查 Redis
docker-compose exec redis redis-cli ping

# 检查后端 API
curl http://localhost/api/health
```

## 7. 备份策略

### 7.1 数据库备份

```bash
# 手动备份
docker-compose exec mysql mysqldump \
  -u it_assets_user -p"${MYSQL_PASSWORD}" it_assets \
  > backup_$(date +%Y%m%d_%H%M%S).sql

# 定时备份（crontab）
0 2 * * * /path/to/backup.sh
```

### 7.2 MinIO 备份

```bash
# 使用 mc（MinIO Client）备份
mc mirror minio/assets-images /backup/minio/assets-images
```

### 7.3 自动备份脚本

```bash
#!/bin/bash
# backup.sh

BACKUP_DIR=/backup/it-assets
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
docker-compose exec -T mysql mysqldump \
  -u it_assets_user -p"${MYSQL_PASSWORD}" it_assets \
  > $BACKUP_DIR/db_$DATE.sql

# 压缩备份
gzip $BACKUP_DIR/db_$DATE.sql

# 删除 7 天前的备份
find $BACKUP_DIR -name "db_*.sql.gz" -mtime +7 -delete
```

## 8. 性能优化

### 8.1 数据库索引

参见 [30-MySQL-DDL.md](./30-MySQL-DDL.md) 中的索引定义。

### 8.2 Redis 缓存策略

```python
# 缓存 SKU 列表（5 分钟）
@cache(key="sku:list", ttl=300)
async def get_sku_list():
    return await Sku.all()

# 缓存用户权限（10 分钟）
@cache(key="user:{user_id}:permissions", ttl=600)
async def get_user_permissions(user_id: int):
    return await load_permissions(user_id)
```

### 8.3 MinIO CDN 加速

参见 [70-文件上传与存储规范.md](./70-文件上传与存储规范.md) CDN 配置。

## 9. 安全加固

### 9.1 防火墙规则

```bash
# 只开放必要端口
ufw allow 80/tcp
ufw allow 443/tcp
ufw deny 3306/tcp  # 禁止外部访问数据库
ufw deny 6379/tcp  # 禁止外部访问 Redis
ufw enable
```

### 9.2 HTTPS 强制

```nginx
# Nginx 配置
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

### 9.3 定期安全更新

```bash
# 更新 Docker 镜像
docker-compose pull
docker-compose up -d

# 更新系统包
apt update && apt upgrade -y
```

## 10. 故障排查

### 10.1 常见问题

| 问题 | 排查命令 | 解决方案 |
|-----|---------|---------|
| 容器无法启动 | `docker-compose logs <service>` | 检查配置/依赖 |
| 数据库连接失败 | `docker-compose exec mysql mysqladmin ping` | 检查密码/网络 |
| 502 Bad Gateway | `docker-compose ps` | 检查后端服务状态 |
| 文件上传失败 | `docker-compose logs minio` | 检查 MinIO 权限 |

### 10.2 性能分析

```bash
# 查看容器资源使用
docker stats

# 查看数据库慢查询
docker-compose exec mysql mysql -u root -p \
  -e "SELECT * FROM mysql.slow_log LIMIT 10;"
```

## 11. CI/CD（可选）

### 11.1 GitHub Actions 示例

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/it-assets
            git pull origin main
            docker-compose build
            docker-compose up -d
```

## 12. 运维清单

### 12.1 日常检查

- [ ] 每日检查服务健康状态
- [ ] 每日检查磁盘空间
- [ ] 每日检查错误日志
- [ ] 每周检查备份完整性
- [ ] 每月更新系统补丁

### 12.2 紧急联系方式

- 后端负责人：xxx@example.com
- 前端负责人：yyy@example.com
- 运维负责人：zzz@example.com
