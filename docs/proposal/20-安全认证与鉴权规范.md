# IT物资全生命周期管理系统｜安全认证与鉴权规范（草案）

## 1. 认证架构

### 1.1 Token 方案

- **认证方式**：JWT (JSON Web Token)
- **传输方式**：HTTP Header `Authorization: Bearer <token>`
- **Token 组成**：
  - Header：加密算法声明（HS256 或 RS256）
  - Payload：用户 ID、角色、过期时间
  - Signature：服务端签名

### 1.2 Token 生命周期

| Token 类型 | 有效期 | 用途 | 存储位置 |
|-----------|--------|------|---------|
| Access Token | 2 小时 | API 调用 | 浏览器内存 (不存 localStorage) |
| Refresh Token | 7 天 | 刷新 Access Token | HttpOnly + Secure + SameSite=Strict Cookie |

## 2. 认证接口定义

### 2.1 登录

```yaml
paths:
  /api/v1/auth/login:
    post:
      summary: 用户登录
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [employee_no, password]
              properties:
                employee_no:
                  type: string
                  example: "A012345"
                password:
                  type: string
                  format: password
                  minLength: 8
                  example: "********"
      responses:
        "200":
          description: 登录成功
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success: { type: boolean, example: true }
                  data:
                    type: object
                    required: [access_token, expires_in, user]
                    properties:
                      access_token:
                        type: string
                        description: "JWT Access Token"
                      expires_in:
                        type: integer
                        description: "Access Token 过期时间（秒）"
                        example: 7200
                      user:
                        $ref: "#/components/schemas/UserBrief"
          headers:
            Set-Cookie:
              description: "服务端写入 refresh_token Cookie（HttpOnly + Secure + SameSite=Strict）"
              schema: { type: string }
        "401":
          description: 工号或密码错误
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
```

### 2.2 刷新 Token

```yaml
paths:
  /api/v1/auth/refresh:
    post:
      summary: 刷新 Access Token
      tags: [Auth]
      description: "服务端从 HttpOnly Cookie 读取 refresh_token，前端无需在 JSON Body 传值"
      responses:
        "200":
          description: 刷新成功
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success: { type: boolean }
                  data:
                    type: object
                    required: [access_token, expires_in]
                    properties:
                      access_token: { type: string }
                      expires_in: { type: integer, example: 7200 }
        "401":
          description: Refresh Token 无效或已过期
```

### 2.3 登出

```yaml
paths:
  /api/v1/auth/logout:
    post:
      summary: 登出（Access Token 加入黑名单并清除 refresh_token Cookie）
      tags: [Auth]
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: 登出成功
          content:
            application/json:
              schema:
                type: object
                required: [success]
                properties:
                  success: { type: boolean, example: true }
```

### 2.4 修改密码

```yaml
paths:
  /api/v1/users/me/password:
    put:
      summary: 修改当前用户密码
      tags: [Auth]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [old_password, new_password]
              properties:
                old_password:
                  type: string
                  format: password
                new_password:
                  type: string
                  format: password
                  minLength: 8
                  description: "至少8位，包含字母和数字"
      responses:
        "200":
          description: 修改成功
        "400":
          description: 原密码错误或新密码不符合规则
```

### 2.5 密码重置（管理员）

```yaml
paths:
  /api/v1/admin/users/{id}/reset-password:
    post:
      summary: 管理员重置用户密码
      tags: [Admin]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int64 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [new_password]
              properties:
                new_password: { type: string, minLength: 8 }
      responses:
        "200":
          description: 重置成功
```

## 3. Token 黑名单机制

### 3.1 场景

- 用户主动登出
- 管理员强制下线
- 密码修改后旧 Token 失效

### 3.2 实现方案

**方案一：Redis 黑名单（推荐）**

```yaml
Redis Key: token_blacklist:{jti}
Value: 1
TTL: Token 剩余有效期
```

**方案二：数据库表（备选）**

```sql
CREATE TABLE token_blacklist (
  jti VARCHAR(64) PRIMARY KEY,
  revoked_at DATETIME(3) NOT NULL,
  expires_at DATETIME(3) NOT NULL,
  KEY idx_expires (expires_at)
) ENGINE=InnoDB;
```

### 3.3 验证流程

```
1. 提取 Token 中的 jti (JWT ID)
2. 检查 Redis/DB 是否存在
3. 存在 → 拒绝请求（401 Unauthorized）
4. 不存在 → 继续验证签名和过期时间
```

## 4. 权限控制（RBAC）

### 4.1 角色定义

| 角色 | Key | 说明 |
|-----|-----|------|
| 普通用户 | USER | 浏览物资、创建申请、查看本人资产 |
| 领导 | LEADER | USER 权限 + 处理初审待办 |
| 管理员 | ADMIN | LEADER 权限 + 复审、出库、入库、库存管理 |
| 超级管理员 | SUPER_ADMIN | 全部权限 + RBAC 管理、后台配置 |

### 4.2 权限点示例

```yaml
权限资源（Resource）:
  - DASHBOARD        # 智慧门户
  - STORE            # 物资超市
  - APPLICATION      # 申请管理
  - APPROVAL_LEADER  # 领导审批
  - APPROVAL_ADMIN   # 管理员审批
  - OUTBOUND         # 出库作业
  - INBOUND          # 入库作业
  - ANALYTICS        # 报表分析
  - RBAC_ADMIN       # 权限管理

权限动作（Action）:
  - VIEW             # 查看
  - CREATE           # 创建
  - UPDATE           # 修改
  - DELETE           # 删除
  - APPROVE          # 审批
  - CONFIRM_PICKUP   # 确认自取
  - SHIP             # 发货
```

### 4.3 权限验证流程

```
1. 从 Token 解析用户 ID（可附带 roles 快照）
2. 从 RBAC 关系表/缓存查询用户角色及权限点
3. 校验当前请求的 Resource + Action
4. 通过 → 继续；失败 → 403 Forbidden
```

## 5. 安全策略

### 5.1 密码策略

- **最小长度**：8 位
- **复杂度要求**：至少包含字母和数字
- **Hash 算法**：bcrypt（Cost Factor = 12）
- **禁止弱密码**：123456、password、admin123 等

### 5.2 API 限流

| 端点类型 | 限流策略 |
|---------|---------|
| 登录接口 | 5 次/分钟/IP |
| 普通 API | 100 次/分钟/用户 |
| 文件上传 | 10 次/分钟/用户 |
| 报表导出 | 5 次/分钟/用户 |

**实现方案**：Redis + Sliding Window 算法

### 5.3 敏感操作二次验证

以下操作需要输入密码或验证码：

- 批量删除资产（>10 条）
- 修改 RBAC 权限
- 数据库直接操作（CRUD 工具）
- 强制下线用户

### 5.4 HTTPS 强制

- 生产环境必须启用 HTTPS
- Nginx 配置 HSTS（HTTP Strict Transport Security）
- Refresh Token 只能通过 HttpOnly + Secure Cookie 传输

## 6. 审计日志

### 6.1 记录范围

所有涉及以下操作必须记录审计日志：

- 登录/登出
- 权限变更（角色授权、权限绑定）
- 敏感数据修改（用户信息、密码重置）
- 资产状态变更（出库、报废）
- 申请单审批决策

### 6.2 日志字段

```yaml
AuditLog:
  - id: int64
  - user_id: int64
  - action: string (LOGIN, APPROVE, DELETE_ASSET, etc.)
  - resource_type: string (USER, ASSET, APPLICATION)
  - resource_id: string
  - ip_address: string
  - user_agent: string
  - request_id: string
  - occurred_at: datetime
  - meta_json: json (additional context)
```

### 6.3 日志存储

- **短期日志**：MySQL（保留 90 天）
- **长期归档**：对象存储/日志系统（保留 1 年）

## 7. 前端安全

### 7.1 Token 存储

❌ **禁止**：localStorage.setItem('token', ...)
✅ **推荐**：内存变量 + HttpOnly Cookie（Refresh Token）

### 7.2 XSS 防护

- 用户输入必须转义（React 默认转义）
- 禁止使用 `dangerouslySetInnerHTML`（除非必要且已消毒）
- CSP（Content Security Policy）Header

### 7.3 CSRF 防护

- Refresh Token 使用 SameSite=Strict Cookie
- 状态变更接口验证 Origin/Referer

## 8. 开发与测试

### 8.1 开发环境 Mock Token

```typescript
// 开发环境自动登录（仅用于测试）
const DEV_TOKEN = {
  user_id: 1,
  employee_no: "DEV001",
  roles: ["SUPER_ADMIN"],
  exp: Math.floor(Date.now() / 1000) + 86400
};
```

### 8.2 权限测试 Checklist

- [ ] 未登录访问受保护接口 → 401
- [ ] 普通用户访问管理员接口 → 403
- [ ] Token 过期 → 401 + 提示刷新
- [ ] Refresh Token 过期 → 跳转登录页
- [ ] 登出后 Token 加入黑名单 → 401

## 9. 数据库补充（RBAC 相关表）

见 [30-MySQL-DDL.md](./30-MySQL-DDL.md) 补充章节。
