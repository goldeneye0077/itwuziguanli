# IT物资全生命周期管理系统｜错误码与异常处理（草案）

## 1. 错误码体系设计

### 1.1 错误码格式

```
格式: [HTTP状态码][业务模块][错误序号]
示例: 40301 = 403 (Forbidden) + 01 (通用模块) + 01 (序号)
```

### 1.2 HTTP 状态码映射

| HTTP状态码 | 说明 | 前端处理策略 |
|-----------|------|------------|
| 200 | 成功 | 正常处理响应 |
| 400 | 请求参数错误 | 显示错误提示 |
| 401 | 未登录/Token失效 | 跳转登录页 |
| 403 | 无权限 | 显示无权限提示 |
| 404 | 资源不存在 | 显示404页面 |
| 409 | 业务冲突（如库存不足） | 显示业务错误提示 |
| 422 | 业务逻辑错误 | 显示详细错误信息 |
| 429 | 请求频率超限 | 显示限流提示，延迟重试 |
| 500 | 服务端错误 | 显示友好错误页 |

## 2. 错误码清单

### 2.1 通用错误（40xxx / 50xxx）

```yaml
错误码字典:
  # 认证与授权
  40101: UNAUTHORIZED
    message: "未登录或 Token 已失效"
    http_status: 401
    
  40102: TOKEN_EXPIRED
    message: "Token 已过期，请刷新"
    http_status: 401
    
  40103: TOKEN_INVALID
    message: "Token 无效或格式错误"
    http_status: 401
    
  40104: TOKEN_BLACKLISTED
    message: "Token 已被撤销"
    http_status: 401
    
  40301: PERMISSION_DENIED
    message: "无权限访问此资源"
    http_status: 403
    
  40302: ROLE_INSUFFICIENT
    message: "当前角色权限不足"
    http_status: 403
    
  # 参数验证
  40001: VALIDATION_ERROR
    message: "请求参数验证失败"
    http_status: 400
    details: { field: "字段名", reason: "具体原因" }
    
  40002: MISSING_REQUIRED_FIELD
    message: "缺少必填字段"
    http_status: 400
    
  40003: INVALID_FIELD_FORMAT
    message: "字段格式错误"
    http_status: 400
    
  # 资源不存在
  40401: RESOURCE_NOT_FOUND
    message: "请求的资源不存在"
    http_status: 404
    
  40402: USER_NOT_FOUND
    message: "用户不存在"
    http_status: 404
    
  40403: APPLICATION_NOT_FOUND
    message: "申请单不存在"
    http_status: 404
    
  40404: ASSET_NOT_FOUND
    message: "资产不存在"
    http_status: 404
    
  40405: SKU_NOT_FOUND
    message: "物资档案不存在"
    http_status: 404
    
  # 限流
  42901: RATE_LIMIT_EXCEEDED
    message: "请求频率超限，请稍后重试"
    http_status: 429
    
  # 服务端错误
  50001: INTERNAL_SERVER_ERROR
    message: "服务器内部错误"
    http_status: 500
    
  50002: DATABASE_ERROR
    message: "数据库操作失败"
    http_status: 500
    
  50003: EXTERNAL_SERVICE_ERROR
    message: "外部服务调用失败"
    http_status: 500
```

### 2.2 业务模块错误（业务逻辑冲突 409/422）

```yaml
错误码字典:
  # 申请模块（41xxx）
  41001: STOCK_INSUFFICIENT
    message: "库存不足，无法创建申请"
    http_status: 409
    details: { sku_id: 123, available: 2, requested: 5 }
    
  41002: DELIVERY_ADDRESS_REQUIRED
    message: "快递寄送需要填写收件地址"
    http_status: 400
    
  41003: APPLICATION_STATUS_INVALID
    message: "申请单状态不允许此操作"
    http_status: 422
    
  41004: DUPLICATE_APPLICATION_PENDING
    message: "存在待处理的重复申请"
    http_status: 409
    
  # 审批模块（42xxx）
  42001: APPROVAL_NODE_MISMATCH
    message: "当前审批节点不匹配"
    http_status: 422
    
  42002: ALREADY_APPROVED
    message: "此申请已被审批"
    http_status: 409
    
  42003: APPROVER_UNAUTHORIZED
    message: "无权审批此申请单"
    http_status: 403
    
  # 出库模块（43xxx）
  43001: PICKUP_CODE_INVALID
    message: "提货码无效或已使用"
    http_status: 422
    
  43002: PICKUP_QR_EXPIRED
    message: "二维码已过期"
    http_status: 422
    
  43003: ASSET_NOT_ASSIGNED
    message: "申请单尚未分配具体资产"
    http_status: 422
    
  43004: ALREADY_OUTBOUNDED
    message: "已完成出库，不可重复操作"
    http_status: 409
    
  # 入库模块（44xxx）
  44001: DUPLICATE_SN
    message: "序列号已存在"
    http_status: 409
    details: { sn: "PF3ABC123", existing_asset_id: 456 }
    
  44002: DUPLICATE_ASSET_TAG
    message: "资产标签已存在"
    http_status: 409
    
  44003: OCR_JOB_NOT_READY
    message: "OCR 任务尚未完成或已失败"
    http_status: 422
    
  44004: SKU_CATEGORY_MISMATCH
    message: "SKU 分类不匹配"
    http_status: 400
    
  # 资产管理（45xxx）
  45001: ASSET_STATUS_CONFLICT
    message: "资产状态冲突，无法执行操作"
    http_status: 409
    
  45002: ASSET_IN_USE
    message: "资产正在使用中，无法删除"
    http_status: 409
    
  45003: ASSET_LOCKED
    message: "资产已被锁定，无法操作"
    http_status: 409
    
  # 权限管理（46xxx）
  46001: ROLE_ALREADY_EXISTS
    message: "角色已存在"
    http_status: 409
    
  46002: CANNOT_DELETE_SYSTEM_ROLE
    message: "系统角色不允许删除"
    http_status: 403
    
  46003: PERMISSION_NOT_FOUND
    message: "权限点不存在"
    http_status: 404
```

## 3. 错误响应格式

### 3.1 标准错误响应

```json
{
  "success": false,
  "error": {
    "code": "STOCK_INSUFFICIENT",
    "message": "库存不足，无法创建申请",
    "details": {
      "sku_id": 123,
      "available": 2,
      "requested": 5
    },
    "request_id": "req_abc123xyz",
    "timestamp": "2026-02-05T08:30:00Z"
  }
}
```

### 3.2 字段验证错误响应

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "请求参数验证失败",
    "details": {
      "fields": [
        {
          "field": "delivery_type",
          "message": "必须为 PICKUP 或 EXPRESS"
        },
        {
          "field": "items[0].quantity",
          "message": "必须大于 0"
        }
      ]
    },
    "request_id": "req_def456uvw",
    "timestamp": "2026-02-05T08:31:00Z"
  }
}
```

## 4. 异常处理策略

### 4.1 可预期业务异常

**处理原则**：返回明确错误码，前端友好提示

```python
# Python 示例
class StockInsufficientError(BusinessError):
    code = "STOCK_INSUFFICIENT"
    http_status = 409
    
    def __init__(self, sku_id: int, available: int, requested: int):
        self.details = {
            "sku_id": sku_id,
            "available": available,
            "requested": requested
        }
        super().__init__(f"库存不足：可用 {available}，申请 {requested}")
```

### 4.2 不可预期系统异常

**处理原则**：

1. 记录完整错误堆栈到日志
2. 返回通用 50001 错误码
3. 生成唯一 `request_id` 便于追踪
4. 前端显示友好提示："系统繁忙，请稍后重试（错误编号：req_xxx）"

```python
# Python 示例
@app.exception_handler(Exception)
async def global_exception_handler(request: Request, exc: Exception):
    request_id = generate_request_id()
    logger.error(f"Unhandled exception [{request_id}]", exc_info=exc)
    
    return JSONResponse(
        status_code=500,
        content={
            "success": False,
            "error": {
                "code": "INTERNAL_SERVER_ERROR",
                "message": "系统繁忙，请稍后重试",
                "request_id": request_id
            }
        }
    )
```

### 4.3 数据库事务回滚

**场景**：申请创建过程中任意步骤失败

```python
async def create_application(data: ApplicationCreate):
    async with transaction():
        try:
            # 1. 创建申请单
            app = await create_application_record(data)
            
            # 2. 锁定库存（可能失败）
            await lock_inventory(app.id, data.items)
            
            # 3. 发送通知（可能失败）
            await send_notification(app.applicant_user_id)
            
            return app
        except StockInsufficientError:
            # 事务自动回滚，抛出业务异常
            raise
        except Exception as e:
            # 记录日志，事务回滚，返回系统错误
            logger.error("Application creation failed", exc_info=e)
            raise InternalServerError()
```

## 5. 前端异常处理

### 5.1 Axios 拦截器示例

```typescript
// React + Axios 示例
axios.interceptors.response.use(
  response => response,
  error => {
    const { response } = error;
    const errorData = response?.data?.error;
    
    switch (response?.status) {
      case 401:
        // Token 失效，跳转登录
        if (errorData?.code === 'TOKEN_EXPIRED') {
          message.warning('登录已过期，请重新登录');
          router.push('/login');
        }
        break;
        
      case 403:
        message.error('无权限访问此资源');
        break;
        
      case 409:
        // 业务冲突，展示详细提示
        if (errorData?.code === 'STOCK_INSUFFICIENT') {
          const { available, requested } = errorData.details;
          message.error(`库存不足：可用 ${available} 件，申请 ${requested} 件`);
        } else {
          message.error(errorData?.message || '操作冲突');
        }
        break;
        
      case 422:
        message.error(errorData?.message || '业务逻辑错误');
        break;
        
      case 429:
        message.warning('操作过于频繁，请稍后重试');
        break;
        
      case 500:
        const requestId = errorData?.request_id;
        message.error(`系统繁忙，请稍后重试${requestId ? `（错误编号：${requestId}）` : ''}`);
        break;
        
      default:
        message.error('网络错误，请检查连接');
    }
    
    return Promise.reject(error);
  }
);
```

### 5.2 表单验证错误展示

```typescript
// Ant Design Form 错误回填示例
if (response.error?.code === 'VALIDATION_ERROR') {
  const fieldErrors = response.error.details.fields;
  
  form.setFields(fieldErrors.map(err => ({
    name: err.field,
    errors: [err.message]
  })));
}
```

## 6. 日志与监控

### 6.1 错误日志结构

```json
{
  "level": "ERROR",
  "timestamp": "2026-02-05T08:30:00Z",
  "request_id": "req_abc123",
  "user_id": 42,
  "ip": "192.168.1.100",
  "method": "POST",
  "path": "/api/v1/applications",
  "error_code": "STOCK_INSUFFICIENT",
  "error_message": "库存不足，无法创建申请",
  "details": {
    "sku_id": 123,
    "available": 2,
    "requested": 5
  },
  "stack_trace": "..."
}
```

### 6.2 错误监控告警

**告警规则**：

- 5xx 错误率 > 1%（1 分钟内） → 立即告警
- 特定业务错误激增（如 STOCK_INSUFFICIENT 突增 300%） → 预警
- 数据库连接失败 → 紧急告警

## 7. 测试用例

### 7.1 错误码覆盖测试

```python
# pytest 示例
def test_stock_insufficient_error():
    """测试库存不足错误码"""
    response = client.post("/api/v1/applications", json={
        "items": [{"sku_id": 1, "quantity": 999}]
    })
    
    assert response.status_code == 409
    assert response.json()["error"]["code"] == "STOCK_INSUFFICIENT"
    assert "available" in response.json()["error"]["details"]
```

### 7.2 事务回滚测试

```python
def test_transaction_rollback_on_lock_failure():
    """测试锁库失败时事务回滚"""
    initial_count = count_applications()
    
    with pytest.raises(StockInsufficientError):
        create_application(data_with_insufficient_stock)
    
    # 确保申请单未创建
    assert count_applications() == initial_count
```
