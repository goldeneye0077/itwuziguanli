# IT物资全生命周期管理系统｜总体与通用规范（草案）

本文档基于说明书中给定的核心实体与功能模块，进一步落到接口字段级别（OpenAPI 草案）、通用约定、跨模块数据对象与鉴权规范，供后续后端/前端并行开发对齐使用。

## 1. 术语与范围

- SKU：物资档案（定义），用于展示与申请
- Asset：实物资产（实例），用于入库、分配、出库、持有与追溯
- Application：申请单，贯穿申领、审批、出库/发货、完结
- StockFlow：库存流水（以 Asset 为粒度的动作流水）
- Pickup：现场自取
- Express：快递寄送

## 2. 统一鉴权与权限（RBAC）

### 2.1 认证

- 采用 Bearer Token：`Authorization: Bearer <token>`
- 服务端从 token 中解析 `user_id`，权限判定以 RBAC 关系表为准（token 中可携带 roles 快照用于加速）

### 2.2 权限约定（建议）

- `USER`：浏览物资、创建申请、查看本人资产/申请、查看本人提货券
- `LEADER`：处理领导初审待办
- `ADMIN`：处理管理员复审、出库、自取/快递发货、入库与库存管理
- `SUPER_ADMIN`：权限与后台管理（含菜单/按钮权限配置）

## 3. 通用 API 约定（OpenAPI 草案片段）

### 3.1 通用响应模型

```yaml
components:
  schemas:
    ApiError:
      type: object
      required: [code, message]
      properties:
        code: { type: string, example: "VALIDATION_ERROR" }
        message: { type: string, example: "delivery_type=EXPRESS requires address" }
        details:
          type: object
          additionalProperties: true

    ApiResponse:
      type: object
      required: [success]
      properties:
        success: { type: boolean }
        data: {}
        error: { $ref: "#/components/schemas/ApiError" }

    PageMeta:
      type: object
      required: [page, page_size, total]
      properties:
        page: { type: integer, minimum: 1 }
        page_size: { type: integer, minimum: 1, maximum: 200 }
        total: { type: integer, minimum: 0 }

    PagedResponse:
      type: object
      required: [success, data, meta]
      properties:
        success: { type: boolean, example: true }
        data:
          type: array
          items: {}
        meta: { $ref: "#/components/schemas/PageMeta" }
        error: { $ref: "#/components/schemas/ApiError" }
```

### 3.2 通用枚举

```yaml
components:
  schemas:
    Role:
      type: string
      enum: [USER, LEADER, ADMIN, SUPER_ADMIN]

    DeliveryType:
      type: string
      enum: [PICKUP, EXPRESS]

    AssetStatus:
      type: string
      enum: [IN_STOCK, LOCKED, IN_USE, PENDING_INSPECTION, BORROWED, REPAIRING, SCRAPPED]

    ApplicationType:
      type: string
      enum: [APPLY, RETURN, REPAIR]
      description: "说明书类型为领用/退库/维修，外部接口统一英文枚举"

    ApplicationStatus:
      type: string
      enum:
        - SUBMITTED
        - LOCKED
        - LEADER_APPROVED
        - LEADER_REJECTED
        - ADMIN_APPROVED
        - ADMIN_REJECTED
        - READY_OUTBOUND
        - OUTBOUNDED
        - SHIPPED
        - DONE
        - CANCELLED
```

### 3.3 通用对象（跨模块复用）

```yaml
components:
  schemas:
    UserBrief:
      type: object
      required: [id, employee_no, name, department_id]
      properties:
        id: { type: integer, format: int64 }
        employee_no: { type: string, example: "A012345" }
        name: { type: string, example: "张三" }
        department_id: { type: integer, format: int64 }
        email: { type: string, format: email }
        roles:
          type: array
          items: { $ref: "#/components/schemas/Role" }

    Category:
      type: object
      required: [id, name]
      properties:
        id: { type: integer, format: int64 }
        name: { type: string, example: "笔记本" }
        parent_id: { type: integer, format: int64, nullable: true }

    Sku:
      type: object
      required: [id, category_id, brand, model, spec, reference_price, cover_url, safety_stock_threshold]
      properties:
        id: { type: integer, format: int64 }
        category_id: { type: integer, format: int64 }
        brand: { type: string, example: "Lenovo" }
        model: { type: string, example: "ThinkPad X1 Carbon" }
        spec: { type: string, example: "i7/32G/1T" }
        reference_price: { type: number, format: float, example: 12999.00 }
        cover_url: { type: string, example: "https://minio/.../cover.png" }
        safety_stock_threshold: { type: integer, minimum: 0, example: 3 }
        available_count:
          type: integer
          minimum: 0
          description: "聚合字段：IN_STOCK 且未被锁定的 Asset 数量"

    Asset:
      type: object
      required: [id, asset_tag, sku_id, sn, status, holder_user_id, inbound_at]
      properties:
        id: { type: integer, format: int64 }
        asset_tag: { type: string, example: "IT-2026-000001" }
        sku_id: { type: integer, format: int64 }
        sn: { type: string, example: "PF3ABCDEF" }
        status: { $ref: "#/components/schemas/AssetStatus" }
        holder_user_id: { type: integer, format: int64, nullable: true }
        inbound_at: { type: string, format: date-time }

    ApplicationItem:
      type: object
      required: [sku_id, quantity]
      properties:
        sku_id: { type: integer, format: int64 }
        quantity: { type: integer, minimum: 1, maximum: 50 }
        note: { type: string, maxLength: 500, nullable: true }

    ExpressAddress:
      type: object
      required: [receiver_name, receiver_phone, province, city, district, detail]
      properties:
        receiver_name: { type: string, example: "张三" }
        receiver_phone: { type: string, example: "13800000000" }
        province: { type: string, example: "广东省" }
        city: { type: string, example: "深圳市" }
        district: { type: string, example: "南山区" }
        detail: { type: string, example: "科兴科学园 X 栋 10F" }

    Application:
      type: object
      required: [id, applicant_user_id, type, status, delivery_type, pickup_code, created_at, items]
      properties:
        id: { type: integer, format: int64 }
        applicant_user_id: { type: integer, format: int64 }
        type: { $ref: "#/components/schemas/ApplicationType" }
        status: { $ref: "#/components/schemas/ApplicationStatus" }
        delivery_type: { $ref: "#/components/schemas/DeliveryType" }
        pickup_code:
          type: string
          description: "6 位数字码，可显示为 892-110 形式"
          example: "892110"
        pickup_qr_string:
          type: string
          description: "用于生成动态二维码的服务端字符串（可加密/带签名/带过期）"
          nullable: true
        express_address: { $ref: "#/components/schemas/ExpressAddress", nullable: true }
        items:
          type: array
          items: { $ref: "#/components/schemas/ApplicationItem" }
        created_at: { type: string, format: date-time }

    Logistics:
      type: object
      required: [application_id, receiver_name, receiver_phone, province, city, district, detail, carrier, tracking_no]
      properties:
        application_id: { type: integer, format: int64 }
        receiver_name: { type: string }
        receiver_phone: { type: string }
        province: { type: string }
        city: { type: string }
        district: { type: string }
        detail: { type: string }
        carrier: { type: string, example: "SF" }
        tracking_no: { type: string, example: "SF1234567890" }
        shipped_at: { type: string, format: date-time, nullable: true }
```

## 4. 约束与一致性（实现要点）

- 库存数量：不允许“手工改数字库存”，库存通过 `Asset` 聚合计算（说明书要求）
- 锁库：申请提交后进入 `LOCKED`，按 SKU 选择 `IN_STOCK` 的具体 `Asset` 改为 `LOCKED` 并关联 `application_id`
- 出库：自取确认后资产转为 `IN_USE`（或 `BORROWED`，按组织定义），写 `StockFlow`
- 物流：快递发货录入后写 `Logistics`，并将申请状态置为 `SHIPPED`（或进入“已发货/待签收”的扩展状态）
