name: Path Deploy Check

on:
  pull_request:
  push:

permissions:
  contents: read

jobs:
  classify:
    name: Classify changed paths
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      deploy: ${{ steps.filter.outputs.deploy }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve path filters
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'package.json'
            frontend:
              - 'frontend/**'
              - 'package.json'
            deploy:
              - 'deploy/**'
              - '.github/workflows/**'
              - 'package.json'
            docs:
              - 'docs/**'
              - '*.md'

  report:
    name: Report deployment scope
    needs: classify
    runs-on: ubuntu-latest
    steps:
      - name: Publish scope summary
        run: |
          echo "backend=${{ needs.classify.outputs.backend }}" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "frontend=${{ needs.classify.outputs.frontend }}" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "deploy=${{ needs.classify.outputs.deploy }}" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "docs=${{ needs.classify.outputs.docs }}" | tee -a "$GITHUB_STEP_SUMMARY"

  deploy-config:
    name: Validate deploy config
    needs: classify
    if: needs.classify.outputs.deploy == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate docker compose file
        run: docker compose -f deploy/docker-compose.yml config
